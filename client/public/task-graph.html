<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Graph - Maverick AI</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
        }

        .task-graph-container {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .header-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .project-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        .project-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active { background: #e8f5e8; color: #2e7d32; }
        .status-paused { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e3f2fd; color: #1976d2; }

        .project-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
        }

        .controls-section {
            background: white;
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: #f5f5f5;
        }

        .control-btn.active {
            background: #2196f3;
            color: white;
            border-color: #2196f3;
        }

        .legend {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .graph-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .graph-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .graph-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .graph-container {
            width: 100%;
            height: 70vh;
            position: relative;
            background: #fafafa;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-width: 250px;
            max-width: 350px;
            display: none;
            z-index: 1000;
        }

        .info-panel h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
        }

        .info-panel p {
            margin: 4px 0;
            font-size: 0.9rem;
            color: #666;
        }

        .info-panel .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #999;
        }

        .info-panel .close-btn:hover {
            color: #333;
        }

        @media (max-width: 768px) {
            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .legend {
                justify-content: center;
            }
            
            .graph-container {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="task-graph-container">
        <!-- Header Section -->
        <div class="header-section">
            <div class="project-header">
                <h1 class="project-title" id="project-title">Loading Project...</h1>
                <span class="project-status status-active" id="project-status">Active</span>
            </div>
            
            <div class="project-stats">
                <div class="stat-item">
                    <div class="stat-value" id="total-tasks">-</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completed-tasks">-</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="active-agents">-</div>
                    <div class="stat-label">Active Agents</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="progress-percent">-%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="controls">
                <button class="control-btn active" onclick="filterGraph('all')">All</button>
                <button class="control-btn" onclick="filterGraph('tasks')">Tasks Only</button>
                <button class="control-btn" onclick="filterGraph('agents')">Agents Only</button>
                <button class="control-btn" onclick="filterGraph('checkpoint')">Checkpoints</button>
                <button class="control-btn" onclick="resetZoom()">Reset View</button>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #2196f3;"></div>
                    <span>Task</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>Checkpoint</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50;"></div>
                    <span>Agent</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e91e63;"></div>
                    <span>Final Review</span>
                </div>
            </div>
        </div>

        <!-- Graph Section -->
        <div class="graph-section">
            <div class="graph-header">
                <div class="graph-title">
                    <i class="fas fa-project-diagram"></i>
                    <span>Task & Agent Relationship Graph</span>
                </div>
            </div>
            
            <div class="graph-container" id="graph-container">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading task graph...</p>
                </div>
            </div>
            
            <!-- Info Panel -->
            <div class="info-panel" id="info-panel">
                <button class="close-btn" onclick="closeInfoPanel()">&times;</button>
                <div id="info-content">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Initialize WebSocket connection
        const socket = io();
        
        // State management
        let currentProject = null;
        let currentTaskGraph = null;
        let currentAgents = null;
        let currentFilter = 'all';
        let network = null;
        let nodes = null;
        let edges = null;

        // Colors for different node types
        const nodeColors = {
            task: '#2196f3',
            checkpoint: '#ff9800',
            final_review: '#e91e63',
            agent: '#4caf50',
            // Task status colors
            todo: '#9e9e9e',
            assigned: '#2196f3',
            in_progress: '#ff9800',
            completed: '#4caf50',
            failed: '#f44336'
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadProjectData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Socket event listeners
            socket.on('connect', () => {
                console.log('Connected to server');
            });

            socket.on('projects_listed', (data) => {
                if (data.projects && data.projects.length > 0) {
                    loadProjectDetails(data.projects[0].id);
                }
            });

            socket.on('project_details', (data) => {
                currentProject = data.project;
                loadTaskGraphData(data.project.id);
            });

            socket.on('task_graph_loaded', (data) => {
                currentTaskGraph = data.taskGraph;
                currentAgents = data.agentAssignments;
                renderProjectData();
            });

            // Handle real-time updates
            socket.on('task_status_updated', (data) => {
                updateTaskStatus(data.taskId, data.status, data.agentId);
            });

            socket.on('agent_status_updated', (data) => {
                updateAgentStatus(data.agentId, data.status);
            });
        }

        function loadProjectData() {
            socket.emit('list_projects', {});
        }

        function loadProjectDetails(projectId) {
            socket.emit('get_project_details', { projectId });
        }

        function loadTaskGraphData(projectId) {
            socket.emit('get_task_graph', { projectId });
        }

        function renderProjectData() {
            if (!currentProject || !currentTaskGraph) return;

            updateProjectHeader();
            renderGraph();
        }

        function updateProjectHeader() {
            document.getElementById('project-title').textContent = currentProject.name || `Project ${currentProject.id.substring(0, 8)}`;
            document.getElementById('project-status').textContent = currentProject.status || 'Active';
            document.getElementById('project-status').className = `project-status status-${currentProject.status || 'active'}`;
            
            const totalTasks = currentTaskGraph?.nodes?.length || 0;
            const completedTasks = currentTaskGraph?.nodes?.filter(n => n.data.status === 'completed')?.length || 0;
            const activeAgents = currentAgents ? Object.keys(currentAgents).length : 0;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('active-agents').textContent = activeAgents;
            document.getElementById('progress-percent').textContent = `${progress}%`;
        }

        function renderGraph() {
            const container = document.getElementById('graph-container');
            
            if (!currentTaskGraph || !currentTaskGraph.nodes) {
                container.innerHTML = '<div class="loading-state"><p>No task graph data available</p></div>';
                return;
            }

            // Prepare nodes and edges for vis.js
            const graphData = prepareGraphData();
            
            // Create the network
            const options = {
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD',
                        sortMethod: 'directed',
                        levelSeparation: 100,
                        nodeSpacing: 150
                    }
                },
                physics: {
                    enabled: false
                },
                nodes: {
                    shape: 'box',
                    margin: 10,
                    font: {
                        size: 12,
                        color: '#2c3e50'
                    },
                    borderWidth: 2,
                    borderWidthSelected: 3,
                    chosen: true
                },
                edges: {
                    arrows: {
                        to: { enabled: true, scaleFactor: 0.8 }
                    },
                    color: {
                        color: '#848484',
                        highlight: '#2196f3',
                        hover: '#2196f3'
                    },
                    width: 2,
                    smooth: {
                        type: 'cubicBezier',
                        forceDirection: 'vertical'
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };

            // Clear the container
            container.innerHTML = '';
            
            // Create the network
            network = new vis.Network(container, graphData, options);

            // Add event listeners
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    showNodeInfo(params.nodes[0]);
                } else {
                    closeInfoPanel();
                }
            });

            network.on('hoverNode', function(params) {
                const nodeId = params.node;
                const node = nodes.get(nodeId);
                if (node && node.title) {
                    // Show tooltip is handled by vis.js automatically
                }
            });
        }

        function prepareGraphData() {
            const nodeArray = [];
            const edgeArray = [];
            const processedNodes = new Set();

            // Add task nodes
            if (currentTaskGraph && currentTaskGraph.nodes) {
                currentTaskGraph.nodes.forEach(node => {
                    const task = node.data;
                    const assignedAgent = findAssignedAgent(task.id);
                    
                    let color = nodeColors.task;
                    let label = task.title || 'Untitled Task';
                    
                    if (task.isCheckpoint) {
                        color = nodeColors.checkpoint;
                        label = '📋 ' + label;
                    } else if (task.isFinalReview) {
                        color = nodeColors.final_review;
                        label = '🏁 ' + label;
                    }

                    // Use status color for border
                    const borderColor = nodeColors[task.status] || nodeColors.todo;

                    nodeArray.push({
                        id: task.id,
                        label: label,
                        color: {
                            background: color,
                            border: borderColor
                        },
                        font: { color: 'white' },
                        title: createTaskTooltip(task, assignedAgent),
                        group: 'task',
                        nodeType: 'task',
                        taskData: task
                    });
                    
                    processedNodes.add(task.id);

                    // Add agent node if assigned and not already added
                    if (assignedAgent && !processedNodes.has(assignedAgent.id)) {
                        nodeArray.push({
                            id: assignedAgent.id,
                            label: '👤 ' + assignedAgent.name,
                            color: {
                                background: nodeColors.agent,
                                border: nodeColors.agent
                            },
                            font: { color: 'white' },
                            title: createAgentTooltip(assignedAgent),
                            group: 'agent',
                            nodeType: 'agent',
                            agentData: assignedAgent
                        });
                        
                        processedNodes.add(assignedAgent.id);
                    }

                    // Add edge from agent to task
                    if (assignedAgent) {
                        edgeArray.push({
                            from: assignedAgent.id,
                            to: task.id,
                            color: { color: '#4caf50' },
                            width: 3,
                            label: 'assigned',
                            font: { size: 10 }
                        });
                    }
                });

                // Add dependency edges
                currentTaskGraph.edges.forEach(edge => {
                    if (edge.source && edge.target) {
                        edgeArray.push({
                            from: edge.source,
                            to: edge.target,
                            color: { color: '#848484' },
                            width: 2,
                            label: edge.label || 'depends on',
                            font: { size: 10 }
                        });
                    }
                });
            }

            nodes = new vis.DataSet(nodeArray);
            edges = new vis.DataSet(edgeArray);

            return { nodes: nodes, edges: edges };
        }

        function createTaskTooltip(task, assignedAgent) {
            const status = task.status || 'todo';
            const priority = task.priority || 'medium';
            const effort = task.estimatedHours || 0;
            const agent = assignedAgent ? assignedAgent.name : 'Unassigned';
            
            return `
                <div style="max-width: 300px;">
                    <strong>${task.title}</strong><br/>
                    Status: ${status}<br/>
                    Priority: ${priority}<br/>
                    Effort: ${effort}h<br/>
                    Agent: ${agent}<br/>
                    ${task.isCheckpoint ? '<br/>🔗 Checkpoint Task' : ''}
                    ${task.isFinalReview ? '<br/>🏁 Final Review' : ''}
                </div>
            `;
        }

        function createAgentTooltip(agent) {
            const tasks = getAgentTasks(agent.id);
            const taskCount = tasks.length;
            const completedCount = tasks.filter(t => t.status === 'completed').length;
            
            return `
                <div style="max-width: 300px;">
                    <strong>${agent.name}</strong><br/>
                    Type: ${agent.type.replace(/_/g, ' ')}<br/>
                    Tasks: ${taskCount}<br/>
                    Completed: ${completedCount}<br/>
                    Status: ${agent.status || 'idle'}
                </div>
            `;
        }

        function showNodeInfo(nodeId) {
            const node = nodes.get(nodeId);
            const infoPanel = document.getElementById('info-panel');
            const infoContent = document.getElementById('info-content');
            
            if (!node) return;

            let content = '';
            
            if (node.nodeType === 'task') {
                const task = node.taskData;
                const assignedAgent = findAssignedAgent(task.id);
                const dependencies = task.dependencies ? task.dependencies.filter(d => d).length : 0;
                
                content = `
                    <h4>${task.title}</h4>
                    <p><strong>Type:</strong> ${task.type || 'task'}</p>
                    <p><strong>Status:</strong> ${task.status || 'todo'}</p>
                    <p><strong>Priority:</strong> ${task.priority || 'medium'}</p>
                    <p><strong>Effort:</strong> ${task.estimatedHours || 0} hours</p>
                    <p><strong>Dependencies:</strong> ${dependencies}</p>
                    ${assignedAgent ? `<p><strong>Assigned to:</strong> ${assignedAgent.name}</p>` : '<p><strong>Status:</strong> Unassigned</p>'}
                    ${task.isCheckpoint ? '<p><strong>Type:</strong> Checkpoint Task</p>' : ''}
                    ${task.isFinalReview ? '<p><strong>Type:</strong> Final Review</p>' : ''}
                    <p><strong>Description:</strong></p>
                    <p style="font-size: 0.85em; color: #666; max-height: 100px; overflow-y: auto;">${(task.description || '').substring(0, 200)}${task.description && task.description.length > 200 ? '...' : ''}</p>
                `;
            } else if (node.nodeType === 'agent') {
                const agent = node.agentData;
                const tasks = getAgentTasks(agent.id);
                
                content = `
                    <h4>${agent.name}</h4>
                    <p><strong>Type:</strong> ${agent.type.replace(/_/g, ' ')}</p>
                    <p><strong>Status:</strong> ${agent.status || 'idle'}</p>
                    <p><strong>Assigned Tasks:</strong> ${tasks.length}</p>
                    <p><strong>Completed:</strong> ${tasks.filter(t => t.status === 'completed').length}</p>
                    <p><strong>In Progress:</strong> ${tasks.filter(t => t.status === 'in_progress' || t.status === 'assigned').length}</p>
                    <p><strong>Tasks:</strong></p>
                    <div style="max-height: 120px; overflow-y: auto; font-size: 0.85em;">
                        ${tasks.map(task => `• ${task.title}`).join('<br/>')}
                    </div>
                `;
            }
            
            infoContent.innerHTML = content;
            infoPanel.style.display = 'block';
        }

        function closeInfoPanel() {
            document.getElementById('info-panel').style.display = 'none';
        }

        function filterGraph(filter) {
            currentFilter = filter;
            
            // Update control buttons
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (!network) return;
            
            let nodesToShow = [];
            let edgesToShow = [];
            
            const allNodes = nodes.get();
            const allEdges = edges.get();
            
            switch (filter) {
                case 'tasks':
                    nodesToShow = allNodes.filter(node => node.nodeType === 'task');
                    edgesToShow = allEdges.filter(edge => 
                        nodesToShow.find(n => n.id === edge.from) && 
                        nodesToShow.find(n => n.id === edge.to)
                    );
                    break;
                case 'agents':
                    nodesToShow = allNodes.filter(node => node.nodeType === 'agent');
                    edgesToShow = allEdges.filter(edge => 
                        nodesToShow.find(n => n.id === edge.from) && 
                        nodesToShow.find(n => n.id === edge.to)
                    );
                    break;
                case 'checkpoint':
                    nodesToShow = allNodes.filter(node => 
                        node.nodeType === 'agent' || 
                        (node.nodeType === 'task' && (node.taskData.isCheckpoint || node.taskData.isFinalReview))
                    );
                    edgesToShow = allEdges.filter(edge => 
                        nodesToShow.find(n => n.id === edge.from) && 
                        nodesToShow.find(n => n.id === edge.to)
                    );
                    break;
                default: // 'all'
                    nodesToShow = allNodes;
                    edgesToShow = allEdges;
            }
            
            network.setData({
                nodes: new vis.DataSet(nodesToShow),
                edges: new vis.DataSet(edgesToShow)
            });
        }

        function resetZoom() {
            if (network) {
                network.fit();
            }
        }

        function findAssignedAgent(taskId) {
            if (!currentAgents) return null;
            
            for (const assignment of Object.values(currentAgents)) {
                const task = assignment.tasks.find(t => t.id === taskId);
                if (task) return assignment.agent;
            }
            return null;
        }

        function getAgentTasks(agentId) {
            if (!currentAgents || !currentAgents[agentId]) return [];
            return currentAgents[agentId].tasks || [];
        }

        function updateTaskStatus(taskId, status, agentId) {
            if (currentTaskGraph && network) {
                const node = currentTaskGraph.nodes.find(n => n.id === taskId);
                if (node) {
                    node.data.status = status;
                    // Update node color
                    const borderColor = nodeColors[status] || nodeColors.todo;
                    nodes.update({
                        id: taskId,
                        color: {
                            background: node.data.isCheckpoint ? nodeColors.checkpoint : 
                                       node.data.isFinalReview ? nodeColors.final_review : nodeColors.task,
                            border: borderColor
                        }
                    });
                    updateProjectHeader();
                }
            }
        }

        function updateAgentStatus(agentId, status) {
            if (currentAgents && currentAgents[agentId] && network) {
                currentAgents[agentId].agent.status = status;
                // Could update agent node appearance here if needed
            }
        }

        // Global functions
        window.filterGraph = filterGraph;
        window.resetZoom = resetZoom;
        window.closeInfoPanel = closeInfoPanel;
    </script>
</body>
</html> 